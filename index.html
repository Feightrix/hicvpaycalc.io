<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Choose Your Calculator</title>
<style>
  :root{
    --green:#1B5E20; --green-600:#124318; --orange:#FF7A00;
    --paper:#FFFFFF; --ink:#1f2937; --muted:#6b7280;
    --border:#e5e7eb; --shadow:0 8px 28px rgba(0,0,0,.08), 0 2px 8px rgba(0,0,0,.05);
    --bar-bg: rgba(255,255,255,.22);
    --splash-duration: 2500ms;
    --reveal-duration: 260ms;
    --card-reveal: 380ms;
  }
  *{box-sizing:border-box}
  html,body{
    margin:0; width:100%; min-width:100%;
    color:var(--ink); font-family:ui-sans-serif,system-ui;
    background:#f8fafc; min-height:100vh;
  }
  body.no-scroll{overflow:hidden;}
  body:not(.app-ready) .app-shell{visibility:hidden;}
  /* SPLASH */
  .splash{position:fixed; inset:0; z-index:9999; background:var(--green); display:flex; align-items:center; justify-content:center;}
  .splash-inner{display:flex; flex-direction:column; gap:24px; align-items:center;}
  .splash-logo{width:min(32vw,340px); opacity:0; animation:logoIn .6s ease-out .15s forwards;}
  @keyframes logoIn{to{opacity:1}}
  .bar-wrap{width:min(420px,84vw); height:12px; border-radius:999px; background:var(--bar-bg); overflow:hidden;}
  .bar{height:100%; width:0%; background:#A5D6A7; animation:fill var(--splash-duration) forwards;}
  @keyframes fill{to{width:100%}}
  .splash.out{animation:splashFade .4s forwards;}
  @keyframes splashFade{to{opacity:0}}
  /* PAGE */
  .container{max-width:520px;margin:0 auto;padding:24px}
  .card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
  .card-header{padding:16px 20px;border-bottom:1px solid var(--border)}
  .card-header h2{margin:0;color:var(--green-600)}
  .card-body{padding:20px}
  .field{margin-bottom:14px}
  .input{border:1px solid var(--border);border-radius:12px;padding:10px 12px}
  input,select{border:0;width:100%;font-size:16px;outline:0;background:transparent}
  .btn{border-radius:999px;padding:10px 18px;border:1px solid var(--border);cursor:pointer;font-weight:700}
  .btn.primary{background:var(--green);color:#fff;border-color:var(--green)}
  .desc{margin-top:10px;color:#6b7280;font-size:14px}
  .welcome{font-weight:800;color:var(--green-600);margin-bottom:10px;display:none}
</style>
</head>

<body class="no-scroll">

<!-- SPLASH -->
<div class="splash" id="splash">
  <div class="splash-inner">
    <img src="images/HI-Emblem-White.png" class="splash-logo" alt="">
    <div class="bar-wrap"><div class="bar"></div></div>
  </div>
</div>

<!-- APP -->
<div class="container app-shell">
  <div class="card">
    <div class="card-header">
      <h2>Choose Your Calculator</h2>
    </div>
    <div class="card-body">

      <div id="welcome" class="welcome"></div>

      <div class="field">
        <div class="input">
          <input id="empNumber" placeholder="Employee Number">
        </div>
      </div>

      <div class="field">
        <div class="input">
          <input id="empName" placeholder="First Name">
        </div>
      </div>

      <div class="field">
        <div class="input">
          <select id="calcSelect">
            <option value="pay">Pay Calculator</option>
            <option value="site">Site Calculator</option>
          </select>
        </div>
      </div>

      <button id="signInBtn" class="btn primary">Continue</button>
      <div id="status" class="desc"></div>

    </div>
  </div>
</div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* SPLASH */
const splash=document.getElementById("splash");
setTimeout(()=>{
  splash.classList.add("out");
  document.body.classList.remove("no-scroll");
  document.body.classList.add("app-ready");
  splash.style.display="none";
},2600);

/* CONFIG */
const SUPABASE_URL="https://mqiofvksgipmowyfjqjn.supabase.co";
const SUPABASE_ANON="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xaW9mdmtzZ2lwbW93eWZqcWpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwOTI1NTcsImV4cCI6MjA4MzY2ODU1N30.SRXzBegzmjvXcJHxIwH8sBSlWO6A2tsTC274wR-Ioe8";
const PREFIX="hi-calc:v2";

/* HELPERS */
const normEmp=v=>String(v||"").replace(/\D/g,"").padStart(6,"0");
const firstOnly=v=>String(v||"").trim().split(/\s+/)[0]||"Unknown";

/* HEADERED CLIENT */
function clientFor(emp,name){
  return window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON,{
    global:{headers:{
      apikey:SUPABASE_ANON,
      Authorization:`Bearer ${SUPABASE_ANON}`,
      "x-employee-number":emp,
      "x-first-name":name
    }}
  });
}

/* DOM */
const empInput=document.getElementById("empNumber");
const nameInput=document.getElementById("empName");
const btn=document.getElementById("signInBtn");
const status=document.getElementById("status");
const welcome=document.getElementById("welcome");
const select=document.getElementById("calcSelect");

/* SIGN IN */
btn.onclick=async()=>{
  status.textContent="";
  const emp=normEmp(empInput.value);
  const name=firstOnly(nameInput.value);

  if(!emp||!name){
    status.textContent="Employee number and first name required.";
    return;
  }

  try{
    const sb=clientFor(emp,name);

    await sb.from("profiles").upsert({
      employee_number:emp,
      first_name:name,
      updated_at:new Date().toISOString()
    });

    await sb.from("calculator_state").upsert({
      employee_number:emp,
      first_name:name,
      page:"calculator-selection",
      data:{name,selection:select.value},
      state:{name,selection:select.value},
      updated_at:new Date().toISOString()
    });

    sessionStorage.setItem(`${PREFIX}:last-employee`,emp);
    sessionStorage.setItem(`${PREFIX}:${emp}:calculator-selection`,JSON.stringify({name}));

    welcome.textContent=`Welcome, ${name}`;
    welcome.style.display="block";

    location.href=select.value==="pay"
      ? "site-selection.html"
      : "site-calculator.html";

  }catch(err){
    console.error(err);
    status.textContent="Sign-in failed. Check console.";
  }
};
</script>
</body>
</html>
